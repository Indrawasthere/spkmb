// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  auditLogs  AuditLog[]
  proyekPUPR ProyekPUPR[]

  @@map("users")
}

enum UserRole {
  ADMIN
  USER
  AUDITOR
  MANAGER
}

// Audit Logs
model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  entity    String
  entityId  String?
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("audit_logs")
}

// Manajemen Paket
model Paket {
  id              String      @id @default(cuid())
  kodePaket       String      @unique
  kodeRUP         String?
  namaPaket       String
  jenisPaket      String
  nilaiPaket      Float
  metodePengadaan MetodePengadaan
  status          PaketStatus @default(DRAFT)
  tanggalBuat     DateTime    @default(now())
  tanggalUpdate   DateTime    @updatedAt
  createdBy       String
  updatedBy       String?
  tanggalMulai    DateTime?
  tanggalSelesai  DateTime?
  lamaProyek      Int?
  dokumenKontrak  String?

  // Relations
  dokumen    Dokumen[]
  laporan    LaporanItwasda[]
  temuanBPKP TemuanBPKP[]
  ppkData    PPKData[]
  vendors    Vendor[]

  @@map("paket")
}

enum PaketStatus {
  DRAFT
  PUBLISHED
  ON_PROGRESS
  COMPLETED
  CANCELLED
}

enum MetodePengadaan {
  E_PURCHASING
  SWAKELOLA
  TENDER
  PENUNJUKAN_LANGSUNG
  SELEKSI
}

enum DokumenJenis {
  JAMINAN_UANG_MUKA
  JAMINAN_PELAKSANAAN
  JAMINAN_PEMELIHARAAN
  // Add other existing types if any
}

// Dokumen & Arsip
model Dokumen {
  id           String        @id @default(cuid())
  paketId      String?
  namaDokumen  String
  jenisDokumen String
  filePath     String
  fileSize     Int
  mimeType     String?
  uploadedBy   String
  uploadedAt   DateTime      @default(now())

  // Relations
  paket           Paket?           @relation(fields: [paketId], references: [id], onDelete: Cascade)
  laporanItwasda  LaporanItwasda?  @relation(fields: [laporanItwasdaId], references: [id], onDelete: Cascade)
  vendor          Vendor?          @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  ppk             PPK?             @relation(fields: [ppkId], references: [id], onDelete: Cascade)
  monitoring      Monitoring?      @relation(fields: [monitoringId], references: [id], onDelete: Cascade)
  laporanAnalisis LaporanAnalisis? @relation(fields: [laporanAnalisisId], references: [id], onDelete: Cascade)
  temuanBPKP      TemuanBPKP?      @relation(fields: [temuanBPKPId], references: [id], onDelete: Cascade)
  proyekPUPR      ProyekPUPR?      @relation(fields: [proyekPUPRId], references: [id], onDelete: Cascade)

  // Foreign keys
  laporanItwasdaId  String?
  vendorId          String?
  ppkId             String?
  monitoringId      String?
  laporanAnalisisId String?
  temuanBPKPId      String?
  proyekPUPRId      String?

  @@map("dokumen")
}

// Pengawasan & Audit
model LaporanItwasda {
  id                     String               @id @default(cuid())
  nomorLaporan           String               @unique
  paketId                String?
  jenisLaporan           String
  deskripsi              String
  tingkatKualitasTemuan  KualitasTemuanLevel
  status                 LaporanStatus        @default(BARU)
  tanggal                DateTime
  auditor                String
  pic                    String
  filePath               String?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  // Relations
  paket Paket? @relation(fields: [paketId], references: [id], onDelete: Cascade)

  // Relations
  dokumen Dokumen[]

  @@map("laporan_itwasda")
}

// BPKP Temuan
model TemuanBPKP {
  id                     String               @id @default(cuid())
  nomorTemuan            String               @unique
  paketId                String?
  jenisTemuan            String
  deskripsi              String
  tingkatKualitasTemuan  KualitasTemuanLevel
  status                 LaporanStatus        @default(BARU)
  tanggal                DateTime             @default(now())
  auditor                String
  pic                    String
  filePath               String?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  // Relations
  paket   Paket?    @relation(fields: [paketId], references: [id], onDelete: Cascade)
  dokumen Dokumen[]

  @@map("temuan_bpkp")
}

enum KualitasTemuanLevel {
  RENDAH
  SEDANG
  TINGGI
  KRITIS
}

enum LaporanStatus {
  BARU
  PROSES
  SELESAI
  DITUNDA
}

// Vendor / Penyedia
model Vendor {
  id              String       @id @default(cuid())
  namaVendor      String
  jenisVendor     VendorType
  nomorIzin       String       @unique
  spesialisasi    String?
  jumlahProyek    Int          @default(0)
  rating          Float?       @default(0)
  status          VendorStatus @default(AKTIF)
  kontak          String?
  alamat          String?
  paketId         String?
  noKontrak       String?
  deskripsi       String?
  dokumenDED      String?
  lamaKontrak     Int?
  warningTemuan   Boolean?     @default(false)
  namaProyek      String?
  deskripsiLaporan String?
  dokumenLaporan  String?
  deskripsiProgress String?
  uploadDokumen   String?
  uploadFoto      String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  paket   Paket?    @relation(fields: [paketId], references: [id], onDelete: Cascade)
  dokumen Dokumen[]

  @@map("vendor")
}

enum VendorType {
  KONSULTAN_PERENCANAAN
  KONSULTAN_PENGAWAS
  KONSTRUKSI
}

enum VendorStatus {
  AKTIF
  NON_AKTIF
  SUSPENDED
}

// Kompetensi PPK
model PPK {
  id          String    @id @default(cuid())
  namaLengkap String
  nip         String    @unique
  jabatan     String
  unitKerja   String
  kompetensi  Json // Store kompetensi as JSON
  sertifikasi Json // Store sertifikasi as JSON
  pengalaman  Int       @default(0)
  status      PPKStatus @default(AKTIF)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  dokumen Dokumen[]

  @@map("ppk")
}

enum PPKStatus {
  AKTIF
  NON_AKTIF
  CUTI
}

// Monitoring & Evaluasi
model Monitoring {
  id                String           @id @default(cuid())
  paketId           String?
  jenisMonitoring   String
  periode           String
  status            MonitoringStatus @default(ON_TRACK)
  progress          Int              @default(0)
  issues            String?
  rekomendasi       String?
  tanggalMonitoring DateTime
  monitoredBy       String
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relations
  dokumen Dokumen[]

  @@map("monitoring")
}

enum MonitoringStatus {
  ON_TRACK
  DELAYED
  CRITICAL
  COMPLETED
}

// Laporan & Analisis
model LaporanAnalisis {
  id           String   @id @default(cuid())
  jenisLaporan String
  periode      String
  data         Json // Store analysis data as JSON
  kesimpulan   String
  rekomendasi  String?
  generatedBy  String
  generatedAt  DateTime @default(now())

  // Relations
  dokumen Dokumen[]

  @@map("laporan_analisis")
}

model ProyekPUPR {
  id                     String               @id @default(cuid())
  namaProyek             String
  lokasi                 String
  anggaran               Float
  kontraktor             String?
  tanggalMulai           DateTime
  tanggalSelesai         DateTime
  status                 ProyekStatus         @default(PERENCANAAN)
  progress               Int                  @default(0)
  deskripsiCatatan       String?
  dokumenCatatan         String?
  tingkatKualitasTemuan  KualitasTemuanLevel?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  // Relations
  createdBy String?
  user      User?     @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  dokumen   Dokumen[]

  @@map("proyek_pupr")
}

model PPKData {
  id               String   @id @default(cuid())
  paketId          String
  namaPPK          String
  noSertifikasi    String
  jumlahAnggaran   Float
  lamaProyek       Int
  realisasiTermin1 Float?
  realisasiTermin2 Float?
  realisasiTermin3 Float?
  realisasiTermin4 Float?
  PHO              DateTime?
  FHO              DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  paket Paket @relation(fields: [paketId], references: [id], onDelete: Cascade)

  @@map("ppk_data")
}

model Pengaduan {
  id        String      @id @default(cuid())
  judul     String
  isi       String
  status    PengaduanStatus @default(BARU)
  tanggal   DateTime    @default(now())
  pelapor   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@map("pengaduan")
}

enum PengaduanStatus {
  BARU
  DIPROSES
  SELESAI
  DITOLAK
}

enum ProyekStatus {
  PERENCANAAN
  PELAKSANAAN
  SELESAI
  DITUNDA
}

// Pengaturan & Hak Akses
model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions Json // Store permissions as JSON
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  resource    String
  action      String
  description String?
  createdAt   DateTime @default(now())

  @@map("permissions")
}
